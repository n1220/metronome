<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>高度な構成管理メトロノーム</title>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: #fff; text-align: center; padding: 20px; }
        .monitor { background: #222; padding: 20px; border-radius: 10px; border: 2px solid #00ffcc; margin-bottom: 20px; }
        .display { font-size: 50px; color: #00ffcc; font-weight: bold; }
        .panel { background: #333; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        input { width: 60px; padding: 8px; margin: 5px; border-radius: 4px; border: none; text-align: center; }
        
        button { padding: 8px 12px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; margin: 2px; }
        .btn-add { background: #007bff; color: white; }
        .btn-play { background: #28a745; color: white; font-size: 24px; padding: 15px 50px; margin-top: 20px; }
        .btn-stop { background: #dc3545; }
        
        /* 操作用 */
        .btn-del { background: #ff4444; color: white; }
        .btn-copy { background: #17a2b8; color: white; }
        .btn-go { background: #f39c12; color: white; }
        
        .jump-input { width: 40px; padding: 5px; font-size: 12px; }

        table { width: 100%; max-width: 900px; margin: 0 auto; border-collapse: collapse; }
        th, td { border-bottom: 1px solid #444; padding: 10px; font-size: 14px; }
        .active { background: rgba(0, 255, 204, 0.2); border-left: 5px solid #00ffcc; }
    </style>
</head>
<body>

    <div class="monitor">
        <div class="display"><span id="cur-m">1</span> - <span id="cur-b">1</span></div>
        <div id="cur-info">STOPPED</div>
    </div>

    <div class="panel">
        <div>
            小節数: <input type="number" id="in-len" value="4">
            拍子: <input type="number" id="in-m" value="4"> / <input type="number" id="in-n" value="4">
            BPM: <input type="number" id="in-bpm" value="120">
        </div>
        <button class="btn-add" id="add-btn">＋ セクションを追加</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>No.</th><th>小節</th><th>拍子</th><th>BPM</th><th>移動先へ</th><th>操作</th>
            </tr>
        </thead>
        <tbody id="list-body"></tbody>
    </table>

    <button id="play-btn" class="btn-play">START</button>

<script>
    let songStructure = [{ len: 4, m: 4, n: 4, bpm: 120 }];
    let audioCtx = null;
    let isPlaying = false;
    let nextNoteTime = 0.0;
    let beatCount = 0;
    let measureInSection = 1;
    let sectionIdx = 0;
    let timerID = null;

    const listBody = document.getElementById('list-body');
    const playBtn = document.getElementById('play-btn');

    function render() {
        listBody.innerHTML = '';
        songStructure.forEach((s, idx) => {
            const tr = document.createElement('tr');
            tr.id = `row-${idx}`;
            tr.innerHTML = `
                <td>${idx + 1}</td>
                <td>${s.len}</td>
                <td>${s.m}/${s.n}</td>
                <td>${s.bpm}</td>
                <td>
                    <input type="number" class="jump-input" id="jump-${idx}" value="${idx + 1}" min="1" max="${songStructure.length}">
                    <button class="btn-go" onclick="jumpSection(${idx})">Go</button>
                </td>
                <td>
                    <button class="btn-copy" onclick="copySection(${idx})">コピー</button>
                    <button class="btn-del" onclick="deleteSection(${idx})">削除</button>
                </td>
            `;
            listBody.appendChild(tr);
        });
    }

    // --- ジャンプ移動ロジック ---
    window.jumpSection = (fromIdx) => {
        const input = document.getElementById(`jump-${fromIdx}`);
        let toIdx = parseInt(input.value) - 1; // 1ベースを0ベースに変換

        if (isNaN(toIdx) || toIdx < 0) toIdx = 0;
        if (toIdx >= songStructure.length) toIdx = songStructure.length - 1;

        // 配列の要素を移動させる
        const targetItem = songStructure.splice(fromIdx, 1)[0];
        songStructure.splice(toIdx, 0, targetItem);
        
        render();
    };

    window.copySection = (idx) => {
        const copy = { ...songStructure[idx] };
        songStructure.splice(idx + 1, 0, copy);
        render();
    };

    window.deleteSection = (idx) => {
        songStructure.splice(idx, 1);
        render();
    };

    document.getElementById('add-btn').onclick = () => {
        songStructure.push({
            len: parseFloat(document.getElementById('in-len').value),
            m: parseFloat(document.getElementById('in-m').value),
            n: parseFloat(document.getElementById('in-n').value),
            bpm: parseFloat(document.getElementById('in-bpm').value)
        });
        render();
    };

    // --- メトロノーム音源とスケジューラー (省略せず統合) ---
    function playClick(time, beat) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.frequency.value = (Math.floor(beat) === 0) ? 1200 : 800;
        gain.gain.setValueAtTime(0.1, time);
        gain.gain.exponentialRampToValueAtTime(0.001, time + 0.05);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start(time);
        osc.stop(time + 0.05);
    }

    function scheduler() {
        while (nextNoteTime < audioCtx.currentTime + 0.1) {
            const current = songStructure[sectionIdx];
            if (!current) { togglePlay(); return; }

            document.querySelectorAll('tr').forEach(r => r.className = '');
            const activeRow = document.getElementById(`row-${sectionIdx}`);
            if(activeRow) activeRow.className = 'active';

            document.getElementById('cur-m').textContent = measureInSection;
            document.getElementById('cur-b').textContent = Math.floor(beatCount) + 1;
            document.getElementById('cur-info').textContent = `${current.m}/${current.n}拍子 / ${current.bpm}BPM`;

            playClick(nextNoteTime, beatCount);
            const secondsPerBeat = (60.0 / current.bpm) * (4.0 / current.n);
            let step = 1.0;
            if (beatCount + 1 > current.m) step = current.m - beatCount;
            nextNoteTime += secondsPerBeat * step;

            beatCount += step;
            if (beatCount >= current.m) {
                beatCount = 0;
                measureInSection++;
                if (measureInSection > current.len) {
                    measureInSection = 1;
                    sectionIdx++;
                }
            }
        }
        timerID = setTimeout(scheduler, 25);
    }

    function togglePlay() {
        if (!audioCtx) audioCtx = new AudioContext();
        if (songStructure.length === 0) return;
        isPlaying = !isPlaying;
        if (isPlaying) {
            sectionIdx = 0; beatCount = 0; measureInSection = 1;
            nextNoteTime = audioCtx.currentTime;
            scheduler();
            playBtn.textContent = 'STOP';
            playBtn.classList.add('btn-stop');
        } else {
            clearTimeout(timerID);
            playBtn.textContent = 'START';
            playBtn.classList.remove('btn-stop');
            document.getElementById('cur-info').textContent = 'STOPPED';
        }
    }

    playBtn.onclick = togglePlay;
    render();
</script>
</body>
</html>
