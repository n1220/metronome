<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>„É°„Éà„É≠„Éé„Éº„É†</title>
    <style>
        :root { 
            --bg: #1a1a1b; --panel: #2d2d2e; --txt: #fff;
            --ok: #00fa9a; --err: #ff4b00; --info: #3da4ff; --warn: #f39c12; --brd: #4a4a4b;
        }
        body { font-family: sans-serif; background: var(--bg); color: var(--txt); text-align: center; padding: 15px; margin: 0; line-height: 1.5; }
        .monitor { background: #000; padding: 20px; border-radius: 12px; border: 3px solid var(--info); margin-bottom: 15px; }
        .display { font-size: 48px; color: var(--ok); font-weight: bold; }
        .loop-display { color: var(--warn); font-size: 18px; margin-top: 8px; border-top: 1px solid var(--brd); padding-top: 8px; }
        .panel { background: var(--panel); padding: 15px; border-radius: 10px; border: 1px solid var(--brd); margin-bottom: 15px; text-align: left; }
        .panel-row { margin-bottom: 10px; display: flex; align-items: center; flex-wrap: wrap; gap: 10px; }
        input, select { padding: 8px; border-radius: 6px; border: 2px solid var(--brd); background: #1a1a1b; color: #fff; font-weight: bold; }
        input[type="number"] { width: 65px; }
        .vol-row { background: rgba(61, 164, 255, 0.15); padding: 12px; border-radius: 8px; display: flex; align-items: center; gap: 12px; border: 2px solid var(--info); }
        input[type="range"] { flex-grow: 1; accent-color: var(--info); cursor: pointer; }
        button { padding: 8px 14px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; transition: opacity 0.2s; }
        .btn-add { background: var(--info); color: #000; }
        .btn-play { background: var(--ok); color: #000; font-size: 24px; padding: 15px; width: 100%; margin-top: 10px; }
        .btn-stop { background: var(--err) !important; color: #fff; }
        table { width: 100%; max-width: 900px; margin: 15px auto; border-collapse: separate; border-spacing: 0 4px; }
        th { background: #333; padding: 10px; font-size: 14px; border-bottom: 2px solid var(--brd); }
        td { background: #252526; padding: 10px; font-size: 14px; border-top: 1px solid var(--brd); border-bottom: 1px solid var(--brd); }
        .active { background: #3d4d4a !important; outline: 3px solid var(--ok); outline-offset: -3px; color: var(--ok); font-weight: bold; }
    </style>
</head>
<body>

    <div class="monitor">
        <div class="display"><span id="cur-m">--</span> - <span id="cur-b">--</span></div>
        <div id="cur-info">READY (Optimized)</div>
        <div class="loop-display">Loop: <span id="cur-loop">0</span> / <span id="max-loop-display">0</span> | BPM: <span id="cur-bpm-display">--</span></div>
    </div>

    <div class="panel">
        <div class="vol-row"><span>üîä VOL</span><input type="range" id="vol-slider" min="0" max="150" value="80"><span id="vol-val">80%</span></div>
        <div class="panel-row">
            Â∞èÁØÄ: <input type="number" id="in-len" value="4"> 
            ÊãçÂ≠ê: <input type="number" id="in-m" value="4"> / <input type="number" id="in-n" value="4"> 
            BPM: <input type="number" id="in-bpm" value="120">
            <button class="btn-add" onclick="addS()">Ôºã ËøΩÂä†</button>
        </div>
        <div class="panel-row" style="background: rgba(255,255,255,0.05); padding: 8px; border-radius: 8px;">
            „É´„Éº„Éó: <input type="number" id="loop-count" value="1"> Âõû | Âä†ÈÄü: <input type="number" id="accel-val" value="0">
        </div>
        <div class="panel-row">
            <input type="text" id="save-name" placeholder="‰øùÂ≠òÂêç" style="width: 100px;">
            <button style="background:#bf7fff" onclick="saveP()">üíæ ‰øùÂ≠ò</button>
            <select id="load-select"><option value="">-- Ë™≠Ëæº --</option></select>
            <button style="background:#fdfd8e" onclick="loadP()">üìÇ Ë™≠Ëæº</button>
            <button style="background:var(--err); color:#fff" onclick="delP()">üóëÔ∏è</button>
        </div>
    </div>

    <table>
        <thead><tr><th>No.</th><th>Â∞èÁØÄ</th><th>ÊãçÂ≠ê</th><th>BPM</th><th>ÁßªÂãï</th><th>Êìç‰Ωú</th></tr></thead>
        <tbody id="list-body"></tbody>
    </table>
    <button id="play-btn" class="btn-play" onclick="togglePlay()">START</button>

<script>
    let songStructure = [], audioCtx = null, masterGain = null, isPlaying = false, timerID = null;
    let nextTime = 0, beat = 0, mInS = 1, sIdx = 0, curL = 1, bpmO = 0, lastSIdx = -1;
    const el = (id) => document.getElementById(id), KEY = 'metronome_presets_v2';

    el('vol-slider').oninput = (e) => {
        const v = e.target.value; el('vol-val').textContent = v + "%";
        if (masterGain) masterGain.gain.setTargetAtTime(v / 80, audioCtx.currentTime, 0.01);
    };

    const getP = () => JSON.parse(localStorage.getItem(KEY) || '{}');
    const upList = () => {
        const p = getP(); el('load-select').innerHTML = '<option value="">-- Ë™≠Ëæº --</option>' + Object.keys(p).map(n => `<option value="${n}">${n}</option>`).join('');
    };

    const saveP = () => {
        const n = el('save-name').value.trim(); if (!n || !songStructure.length) return alert("ÂÖ•Âäõ‰∏çË∂≥");
        const p = getP(); p[n] = { s: songStructure, l: el('loop-count').value, a: el('accel-val').value };
        localStorage.setItem(KEY, JSON.stringify(p)); upList(); alert("‰øùÂ≠òÂÆå‰∫Ü");
    };

    const loadP = () => {
        const d = getP()[el('load-select').value]; if (!d) return;
        songStructure = d.s; el('loop-count').value = d.l; el('accel-val').value = d.a; render();
    };

    const delP = () => {
        const n = el('load-select').value; if (n && confirm("ÂâäÈô§Ôºü")) { const p = getP(); delete p[n]; localStorage.setItem(KEY, JSON.stringify(p)); upList(); }
    };

    const render = () => {
        el('list-body').innerHTML = songStructure.map((s, i) => `<tr id="row-${i}"><td>${i+1}</td><td>${s.len}</td><td>${s.m}/${s.n}</td><td>${s.bpm}</td><td><input type="number" id="j-${i}" value="${i+1}" style="width:35px"><button onclick="jump(${i})">Go</button></td><td><button onclick="copy(${i})">Ë§áË£Ω</button><button style="background:var(--err);color:#fff" onclick="del(${i})">√ó</button></td></tr>`).join('');
    };

    const addS = () => {
        songStructure.push({ len: +el('in-len').value, m: +el('in-m').value, n: +el('in-n').value, bpm: +el('in-bpm').value }); render();
    };
    window.jump = (f) => { let t = +el(`j-${f}`).value - 1; songStructure.splice(t < 0 ? 0 : t, 0, songStructure.splice(f, 1)[0]); render(); };
    window.copy = (i) => { songStructure.splice(i+1, 0, {...songStructure[i]}); render(); };
    window.del = (i) => { songStructure.splice(i, 1); render(); };

    const click = (t, b, chg) => {
        const o = audioCtx.createOscillator(), g = audioCtx.createGain(); o.type = 'triangle';
        o.frequency.setValueAtTime(chg ? 2000 : (Math.floor(b) === 0 ? 1200 : 800), t);
        g.gain.setValueAtTime(chg ? 0.4 : (Math.floor(b) === 0 ? 0.3 : 0.2), t);
        g.gain.exponentialRampToValueAtTime(0.001, t + 0.08); o.connect(g).connect(masterGain); o.start(t); o.stop(t + 0.08);
    };

    function scheduler() {
        const mL = +el('loop-count').value, acc = +el('accel-val').value; el('max-loop-display').textContent = mL;
        while (nextTime < audioCtx.currentTime + 0.1) {
            const c = songStructure[sIdx];
            if (!c) { if (curL < mL) { curL++; sIdx = 0; bpmO += acc; continue; } else return togglePlay(); }
            const isChg = (sIdx !== lastSIdx); lastSIdx = sIdx;
            const bpm = c.bpm + bpmO;
            el('cur-m').textContent = mInS; el('cur-b').textContent = Math.floor(beat) + 1;
            el('cur-loop').textContent = curL; el('cur-bpm-display').textContent = Math.round(bpm);
            document.querySelectorAll('tr').forEach(r => r.classList.remove('active')); el(`row-${sIdx}`)?.classList.add('active');
            click(nextTime, beat, isChg);
            const dur = (60 / bpm) * (4 / c.n);
            let s = 1.0; if (beat + 1 > c.m) s = c.m - beat;
            nextTime += dur * s; beat += s;
            if (beat >= c.m) { beat = 0; mInS++; if (mInS > c.len) { mInS = 1; sIdx++; } }
        }
        timerID = setTimeout(scheduler, 25);
    }

    function togglePlay() {
        if (!songStructure.length) return alert("ËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
        if (!audioCtx) { audioCtx = new AudioContext(); masterGain = audioCtx.createGain(); masterGain.gain.value = el('vol-slider').value / 80; masterGain.connect(audioCtx.destination); }
        isPlaying = !isPlaying;
        if (isPlaying) { sIdx = beat = bpmO = 0; mInS = curL = 1; lastSIdx = -1; nextTime = audioCtx.currentTime; scheduler(); el('play-btn').textContent = 'STOP'; el('play-btn').classList.add('btn-stop'); }
        else { clearTimeout(timerID); el('play-btn').textContent = 'START'; el('play-btn').classList.remove('btn-stop'); }
    }
    upList(); render();
</script>
</body>
</html>